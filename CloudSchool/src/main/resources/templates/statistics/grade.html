<!DOCTYPE html>
<html>

<head>
<meta charset="UTF-8">
<title>年级统计</title>
<meta
	content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no'
	name='viewport' />
<link rel="stylesheet" th:href="@{/static/css/bootstrap.min.css}">
<link rel="stylesheet" th:href="@{/static/css/ready.css}">
<link rel="stylesheet" th:href="@{/static/css/demo.css}">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i">
<style type="text/css">
/* .card {
	border-radius: 0px;
	background-color: #ffffff;
	margin-bottom: 0px;
	-webkit-box-shadow: 0px 1px 15px 1px rgba(69, 65, 78, 0.08);
	-moz-box-shadow: 0px 1px 15px 1px rgba(69, 65, 78, 0.08);
	box-shadow: 0px 1px 15px 1px rgba(69, 65, 78, 0.08);
	border: 1px solid #eee;
} */
/* blockquote p{
	display:inline-block;
	color:black;
	margin:0;
	padding:0;
}
blockquote img{display:none;} */
</style>
</head>

<body>
	<div class="main-panel">
		<div class="content">
			<div class="container-fluid">
				<h4 class="page-title">全年级统计</h4>
				<div id="countInfoSec" class="row">
					<!-- 统计 -->
					<div class="col-md-4">
						<div class="card card-stats">
							<div class="card-body ">
								<div class="row">
									<div class="col-5">
										<div class="icon-big text-center">
											<i class="la la-users"></i>
										</div>
									</div>
									<div class="col-7 d-flex align-items-center">
										<div class="numbers">
											<p class="card-category">学员人数</p>
											<h4 class="card-title">{{countInfoList[0]}}</h4>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="card card-stats">
							<div class="card-body ">
								<div class="row">
									<div class="col-5">
										<div class="icon-big text-center">
											<i class="la la-user-secret"></i>
										</div>
									</div>
									<div class="col-7 d-flex align-items-center">
										<div class="numbers">
											<p class="card-category">教员人数</p>
											<h4 class="card-title">{{countInfoList[1]}}</h4>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="card card-stats">
							<div class="card-body">
								<div class="row">
									<div class="col-5">
										<div class="icon-big text-center">
											<i class="la la-slideshare"></i>
										</div>
									</div>
									<div class="col-7 d-flex align-items-center">
										<div class="numbers">
											<p class="card-category">班级数量</p>
											<h4 class="card-title">{{countInfoList[2]}}</h4>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<!-- 公告 -->
				<div id="noticeSec" class="card col-md-12">
					<div class="card-header">
						<h4 class="card-title" style="text-align: center;">通知</h4>
						
					</div>
					<!-- 标题 -->
					<div class="card-category" style="text-align: center;">{{notice.title}}</div>
					<blockquote>
						<p></p>
						<p class="blockquote blockquote-primary" style="text-indent: 2em;-webkit-user-select:none;">
							{{notice.content | tagFilter}}
							<small style="display: block;text-align: right;">
								- {{notice.sendername}}
							</small>
							<small style="display: block;text-align: right;">
								- {{notice.time}}
							</small>
						</p>
					</blockquote>
				</div>
				
				<!-- 年级成绩统计 -->
				<div class="row">
					<div class="card col-lg-12" id="GradeAndPcAndClazzSec">
						<div class="card-header row" >
							<div class="card-title">年级成绩总汇</div>
							<!--年级-->
							<div v-show="gradeList!=null" class="form-group col-lg-12">
								<label>年级</label> 
								<select v-model="currentgId" class="form-control form-control">
									<option v-for="gradeItem in gradeList" v-bind:value="gradeItem.gradeId">{{gradeItem.gradeName}}</option>
								</select>
							</div>
							<!--批次-->
							<div v-show="pcList!=null" class="form-group col-lg-12">
								<label>批次</label> 
								<select v-model="currentPc"  class="form-control form-control">
									<option v-for="pcItem in pcList" v-bind:value="pcItem.clazzPc">{{pcItem.clazzPc}}</option>
								</select>
							</div>
						</div>
						
						
						
						<div class="card-body" style="text-align: center;">
							<!-- 数据部分（表格和图形） -->
							<div class="col-lg-12">
								<!-- 数据表格 -->
								<div>
									<!-- 该批次下全部班级 -->
									<button v-for="clazzItem in clazzList" v-bind:clazzId="clazzItem.clazzId" class="btn btn-primary btn-border">{{clazzItem.clazzName}}</button>
								</div>
								<table id="clazzTestsAvgScoreByPcSec" v-if="currentTestData!=null" class="table table-bordered" style="text-align: center;">
									<thead>
										<tr>
											<th scope="col">批次</th>
											<th scope="col">班级名称</th>
											<th scope="col">最高分</th>
											<th scope="col">最低分</th>
											<th scope="col">高平均</th>
											<th scope="col">高低均</th>
										</tr>
									</thead>
									<tbody>
										<tr v-for="item in currentTestData">
											<td>{{currentPc}}</td>
											<td>{{item.cName}}</td>
											<td>{{item.maxScore}}</td>
											<td>{{item.minScore}}</td>
											<td>{{item.heightAvgScore}}</td>
											<td>{{item.lowAvgScore}}</td>
										</tr>
									</tbody>
								</table>
								
								
								
								<!--同一批次各个班平均成绩查询-->
								<div id="scoreInfoPicture" style="width: 400; height: 400px;"></div>
							</div>
						
						</div>
						<div class="card-footer row">
								<!-- <i class="col-md-3 la la-circle text-primary">查看详情</i> -->
								<!-- 下载 -->
		
								<a id="downLoadBtn" download="年级成绩分布情况.xls" class="col-md-2 demo-icon" href="#" onclick="return ExcellentExport.excel(this, 'clazzTestsAvgScoreByPcSec', 'sheet');"> 
									<div class="icon-preview">
										<i class="la la-file-excel-o"></i>
									</div>
									<div class="icon-class">
										下载报表
									</div> 
								</a>
								
							</div>
					</div>
				</div>
			</div>
		</div>
</body>
<script type="text/javascript" th:src="@{/static/js/core/vue.js}"></script>
<script type="text/javascript" th:src="@{/static/js/common.js}"></script>
<script type="text/javascript"
	th:src="@{/static/js/statisticsDefaultData.js}"></script>
<script type="text/javascript"
	th:src="@{/static/js/core/jquery.3.2.1.min.js}"></script>
<script src="/static/js/echarts.js"></script>
<script src="/static/js/core/bootstrap.min.js"></script>
<script th:src="@{/static/js/echarts.js}"></script>
	<script type="text/javascript" th:src="@{/static/js/excellentexport.js}"></script>
<script type="text/javascript">
	//全局变量初始化
	var vue = new Vue({
		el:"#GradeAndPcAndClazzSec",
		data:{
			gradeList:null,//年级
			pcList:null,//批次
			clazzList:null,//班级
			currentgId:null,//当前年级,
			currentPc:null,//当前批次,
			currentTestData:null
		},
		beforeUpdate:function(){
			if(vue.currentgId == null)
			vue.currentgId = vue.gradeList[0].gradeId;//默认选中第一个年级
			if(vue.currentPc == null)
			vue.currentPc = vue.pcList[0].clazzPc; 
		},
		watch:{
			currentgId(){
				getGradeInfo(vue.currentgId,'');
			},
			currentPc(){
				getCLazzTestInfo(this.currentPc);
			}
		}
	});
	//初始化echars实例
	var myChar = echarts.init(document.querySelector("#scoreInfoPicture"));
	//设置默认图例
	myChar.setOption(noDataLoadingOption,true);
	//禁止下载按钮
	$("#downLoadBtn").hide();
	//=======================================================
	$(function(){
		initGradeInfo(null,'');//查询全部
		getBaseInfoAboutALlCount();
		getNoticeNewOne();
	});
	//初始化年级基本数据
	function initGradeInfo(gId,pc){
		//查询所有年级下的所有批次下的所有班级
		$.ajax({
			type : "post",
			url : adress.url + "/statistics/getAllGradesAboutPcsAndClazzs",
			data : {
				gId : gId,
				pc : pc
			},
			success : function(data) {
				//console.log(JSON.stringify(data));
				//data = null;
				if(data !=null && data.length>0){
					vue.gradeList = data;
					vue.pcList = data[0].pcList;
				}
				
				
			}
		})
	}
	//查询年级信息
	function getGradeInfo(gId){
		$.ajax({
			type : "post",
			url : adress.url + "/statistics/getAllGradesAboutPcsAndClazzs",
			data : {
				gId : gId,
				pc : ''
			},
			success : function(data) {
				//批次信息初始化
				vue.pcList = data[0].pcList;
				vue.currentPc = vue.pcList[0].clazzPc;
			}
		})
	}
	//查询考试信息  pc批次参数
	function getCLazzTestInfo(pc){ //有班级才调用
		$.ajax({
			type : "post",
			url : adress.url + "/statistics/getAllGradesAboutPcsAndClazzs",
			data : {
				pc : pc
			},
			success : function(data) {
				vue.clazzList = data[0].pcList[0].clazzList;
				getClazzTestsAvgScoreByPc(pc);
			}
		});
	}
	//渲染数据和图形
	function getClazzTestsAvgScoreByPc(pc){
		myChar.showLoading();
		$.ajax({
			type : "post",
			url : adress.url + "/statistics/getClazzTestsAvgScoreByPc",
			data : {
				pc : pc
			},
			success : function(data) {
				//console.log(JSON.stringify(data));
				if(data !=null && data.length >0){
					vue.currentTestData = data;
					var dataArr = [];////[低平均,高平均,最低分,最高分]
					var clazzNameArr = [];//班级名称数组
					for(var i = 0;i<data.length;i++){
						var simClazzData = [];
						//[低平均,高平均,最低分,最高分]
						simClazzData.push(data[i].lowAvgScore);
						simClazzData.push(data[i].heightAvgScore);
						simClazzData.push(data[i].minScore);
						simClazzData.push(data[i].maxScore);
						dataArr.push(simClazzData);
						clazzNameArr.push(data[i].cName);
					}
					var option = {
						    xAxis: {
						        data: clazzNameArr
						    },
						    tooltip : {
						        trigger: 'axis',
						        formatter: function (params) {
						            var res = ' ' + params[0].name;
						            res += '<br/>  低平均 : ' + params[0].value[1] + '  高平均 : ' + params[0].value[2];
						            res += '<br/>  最低分 : ' + params[0].value[3] + '  最高分 : ' + params[0].value[4];
						            return res;
						        }
						    },
						    legend : {
						    	orient: 'vertical',
						        data:[{
						        	name: '最高分\n高均分\n低均分\n最低分'
						        }],
						        x: 'right',
						        y: 'center',
						        itemHeight: 50,
						    },
						    yAxis: {},
						    series: [{
						    	name:"最高分\n高均分\n低均分\n最低分",
						        type: 'k',
						        data: dataArr
						    }]
						};
						myChar.setOption(option,true);
						//设置报表名称
						$("#downLoadBtn").attr("download","批次"+pc+"成绩整体情况报表");
						//显示下载按钮
						$("#downLoadBtn").show();
				}else{
					//没有数据
					vue.currentTestData = null;
					myChar.setOption(noDataLoadingOption,true);
					$("#downLoadBtn").hide();
				}
				myChar.hideLoading();
				
			}
		});
	}
	//查询全校人数信息
	function getBaseInfoAboutALlCount(){
		$.ajax({
			type : "post",
			url : adress.url + "/statistics/getBaseInfoAboutALlCount",
			data : {
				
			},
			success : function(data) {
				var vue = new Vue({
					el:"#countInfoSec",
					data:{
						countInfoList:data
					}
				});
			}
		});
	}
	//查询最新一次公告
	function getNoticeNewOne(){
		$.ajax({
			type : "post",
			url : adress.url + "/queryLastOneInAll",
			data : {
				
			},
			success : function(data) {
				console.log(data);
				var vue = new Vue({
					el:"#noticeSec",
					data:{
						notice:data
					},
					filters:{
						tagFilter:function(value){
							var dd=value.replace(/<\/?.+?>/g,"");//去标签
							var dds=dd.replace(/ /g,"");//dds为得到后的内容
							return dds;
						}
					}
				});
			}
		});
	}
</script>
</html>
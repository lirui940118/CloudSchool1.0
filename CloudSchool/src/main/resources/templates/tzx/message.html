<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>消息</title>
		<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
		<link rel="stylesheet" href="../static/css/bootstrap.min.css">
		<link rel="stylesheet" href="../static/css/ready.css">
    <script type="text/javascript" charset="utf-8" src="../static/ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="../static/ueditor/ueditor.all.js"> </script>
    <script type="text/javascript" charset="utf-8" src="../static/ueditor/lang/zh-cn/zh-cn.js"></script>
	<script src="../static/js/core/jquery.min.js"></script>
	<script src="../static/js/core/vue.js"></script>
	<script src="../static/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
	</head>
	<style>
		.m_left ul li{border-bottom: 1px cadetblue solid;overflow: hidden;}
		.m_message_left{text-align: left;padding: 3px 100px 3px 3px;}
		.m_message_right{text-align: right;padding: 3px 3px 3px 100px;}
/* 		//兼容内容中的p标签 */
		.m_message_left p{display:inline-block;}
		.m_message_right p{display:inline-block;}
/* 		消息内容前的头像间距 */
		.userimg{margin-left:5px;margin-right:5px;}
		/* #editor{height: 100px;} */
		/* #edui1{height: 100px;overflow: hidden;} */
		/* #ueditor_0{height: 75px;} */
		/* 工具栏按钮 */
		#edui1_toolbarbox{height: 25px;overflow: hidden;}
		#edui1_iframeholder{padding-right: 80px;}
		.view body{margin-top: 0;}
		/* 隐藏元素路径和字数统计 */
		#edui1_bottombar{display: none;}
		#edui1_scalelayer{display: none;}
		.m_body img{max-width: 200px;}
		.m_body img:hover{max-width: 100%;}
		.m_unReadCount{
			position: absolute;
			background-color: #ff646d;
			text-align: center;
			border-radius: 10px;
			min-width: 17px;
			height: 17px;
			font-size: 11px;
			color: #ffffff;
			font-weight: bold;
			line-height: 17px;
			top: -11px;
			left: 50px;
		}
		.cpm ul p{background-color:silver;}
		.cpm ul li{list-style: none;}
		.cpm ul li button{font-size: 10px;padding:0px}
		.m_left ul li:hover .closechat{display:block;}
		.closechat{position: absolute;top: -20px;left: 80px;font-size:20px;display:none;}
		.closechat:hover{background-color:red;}
	</style>
	<body>
		<div class="main-panel">
			<div class="content">
				<div class="container-fluid">
					<h4 class="page-title">消息</h4>
					<div class="tzx" style="border: 1px solid red;width: 100%;height: 100%; display: flex; flex-direction: row;">
						<div class="m_left" style="width: 20%;min-width: 50px;min-height:400px;height:400px;overflow:scroll;">
							<ul style="margin: 0;padding: 0;font-size: 14px;">
								<li v-for="obj,index in chatlist" v-bind:nid="obj.userid" v-on:click="jump(obj.userid,obj.name)" style="height: 70px;width: 200px; min-width: 20px;">
									<div class="" style="display: flex;flex-direction: row;position: relative;padding: 5px;" >
										<div class="photo">
											<img v-if="obj.url!=null" v-bind:src="obj.url" style="border-radius: 50%;vertical-align: middle;width: 45px;border-style: none;position: relative;top: -10px;">
											<img v-if="obj.url==null&&obj.usertypenub==0" src="/static/image/teacherHead.jpg" style="border-radius: 50%;vertical-align: middle;width: 45px;border-style: none;position: relative;top: -10px;">
											<img v-if="obj.url==null&&obj.usertypenub==1" src="/static/image/studentImg.png" style="border-radius: 50%;vertical-align: middle;width: 45px;border-style: none;position: relative;top: -10px;">
											<img v-if="obj.url==null&&obj.usertypenub==2" src="/static/image/parents.jpg" style="border-radius: 50%;vertical-align: middle;width: 45px;border-style: none;position: relative;top: -10px;">
										</div>
										<div  class="" style="width: 250px;height: 50px;">
											<span>
												<span class="" style="min-width: 250px;height: 25px;">{{obj.name}}{{obj.positionname}}</span>
												<span class="closechat la la-remove" @click.stop="closechat(obj.userid)" style=""></span>
											</span>
										</div>
									</div>
								</li>
								<li style="height: 70px;width: 200px;" v-on:click="jump(0,'系统')">
									<div class="talking_li" chatid="0" style="display: flex;flex-direction: row;position: relative;padding: 5px;" >
										<div class="photo">
											<img src="../static/image/profile.jpg" alt="头像" style="border-radius: 50%;vertical-align: middle;width: 45px;height:45px;border-style: none;position: relative;top: -10px;">
										</div>
										<div  class="" style="width: 150px;height: 50px;">
											<span>
												<span class="" style="min-width: 250px;height: 25px;">系统</span>
												<span class="m_unReadCount">1</span>
												<span class="closechat la la-remove" v-on:click="closechat(0)" style="display:none;"></span>
											</span>
										</div>
									</div>
								</li>
							</ul>
							<button onclick="ToFindFriend()" class="btn btn-success">查找</button>
							
						</div>
						<div class="m_right" style="width: 100%;min-width: 400px;min-height: 400px;height: 400px; background-color: white;flex-flow: 90%;position: relative;">
							<div style="display: flex;flex-direction: column;height: 100%;">
								<div class="m_top" style="height: 50px;background-color: cadetblue;padding: 5px;vertical-align: middle;">
									<h6>渣渣辉</h6>
								</div>
								<div class="m_body" style="width: 100%;height: 100%;padding-bottom: 100px;overflow: scroll;">
									<div style="height: auto;" class="view">
										<div class="m_message_left">性感亚索在线发牌！</div>
										<div class="m_message_left">ready,GO！<img src="http://img.baidu.com/hi/jx2/j_0003.gif"/></div>
										
									</div>
									<div><a id="msg_end" name="1" href="#1">&nbsp</a></div>
								</div>
								<div class="ediotr" style="width: 100%;background-color: #cccccc;height: 100px;position: absolute;bottom: 0;">
									<script id="editor" type="text/plain" style="width:100%;height:100px;"></script>
									<div style="height: 70px;width: 80px;position: absolute;right: 0px;bottom: 0px;z-index: 999;">
										<button class="btn btn-success" style="width: 100%;height: 100%;" onclick="senderMessage()">发送</button>
										<a class="senderMultiMessage" style="position:absolute;top: -20px;right: 5px;" href="javascript:void(0)" onclick="TosenderMultiMessage()">群发</a>
									</div>
								</div>
							</div>

						</div>
						<div class="cpm" style="display:none;width:100%;height:100%;background-color:#eee;z-index: 999; position:absolute;">
							
							<ul style="margin:20px;">
								<li>
									<p>选择职员</p>
									<ul>
										<li><input type="checkbox" name="" value="1" nid="1" style="position:unset;"><span>xxxx</span><button onclick="chooseOne(1,'阿花1','bk2.jpg')" class="btn btn-success">选择</button></li>
										<li><input type="checkbox" name="" value="2" nid="2" style="position:unset;"><span>xxxx</span><button onclick="chooseOne(2,'阿花2','bk2.jpg')" class="btn btn-success">选择</button></li>
										<li><input type="checkbox" name="" value="3" nid="3" style="position:unset;"><span>xxxx</span><button onclick="chooseOne(3,'阿花3','bk2.jpg')" class="btn btn-success">选择</button></li>
									</ul>
								</li>
								<li>
									<p>选择学生</p>
									<ul>
										<li><input type="checkbox" value="4" style="position:unset;"><span>xxx</span><button onclick="chooseOne(4,'阿花4','profile.jpg')" class="btn btn-success">选择</button></li>
										<li><input type="checkbox" value="6" style="position:unset;"><span>xxx</span><button onclick="chooseOne(6,'阿花6','profile.jpg')" class="btn btn-success">选择</button></li>
										<li><input type="checkbox" value="7" style="position:unset;"><span>xxx</span><button onclick="chooseOne(7,'阿花7','profile.jpg')" class="btn btn-success">选择</button></li>
									</ul>
								</li>
								<li>
									<p>选择家长</p>
									<ul>
										<li><input type="checkbox" value="5" style="position:unset;"><span>xxx</span><button onclick="chooseOne(5,'阿花5','profile.jpg')" class="btn btn-success">选择</button></li>
									</ul>
								</li>
							</ul>
							<p style="text-align: center;">
							<button onclick="chooseAll()" class="btnchooseAll btn btn-success" style="">提交选中</button>
							<button onclick="chooseClose()" class="btnchooseClose btn btn-warning" style="">取消</button>
							</p>
							

						</div>
					</div>
				</div>
				
			</div>
		</div>
	</body>
<script type="text/javascript">
    //实例化编辑器
    //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
    var ue = UE.getEditor('editor',{
		allowDivTransToP: false,
		elementPathEnabled : false,
		wordCount:true,
		maximumWords:500,
		toolbars:[
			[
				// 'source', 'undo',  'redo', //源码,撤销,重做
				'bold', 'italic', 
				'underline','fontborder',
				'strikethrough',
				'superscript', 'subscript', //上标,下标
				// 'removeformat',	//清除格式
				'formatmatch',
				'forecolor', 'backcolor', 
				'link','emotion', 
				'simpleupload','insertimage', 
			]
		]
	});
    function isFocus(e){
        alert(UE.getEditor('editor').isFocus());
        UE.dom.domUtils.preventDefault(e)
    }
    function setblur(e){
        UE.getEditor('editor').blur();
        UE.dom.domUtils.preventDefault(e)
    }
    function insertHtml() {
        var value = prompt('插入html代码', '');
        UE.getEditor('editor').execCommand('insertHtml', value)
    }
    function createEditor() {
        enableBtn();
        UE.getEditor('editor');
    }
    function getAllHtml() {
        alert(UE.getEditor('editor').getAllHtml())
    }
    function getContent() {
        var arr = [];
        arr.push("使用editor.getContent()方法可以获得编辑器的内容");
        arr.push("内容为：");
        arr.push(UE.getEditor('editor').getContent());
        alert(arr.join("\n"));
    }
    function getPlainTxt() {
        var arr = [];
        arr.push("使用editor.getPlainTxt()方法可以获得编辑器的带格式的纯文本内容");
        arr.push("内容为：");
        arr.push(UE.getEditor('editor').getPlainTxt());
        alert(arr.join('\n'))
    }
    function setContent(isAppendTo) {
        var arr = [];
        arr.push("使用editor.setContent('欢迎使用ueditor')方法可以设置编辑器的内容");
        UE.getEditor('editor').setContent('欢迎使用ueditor', isAppendTo);
        alert(arr.join("\n"));
    }
    function setDisabled() {
        UE.getEditor('editor').setDisabled('fullscreen');
        disableBtn("enable");
    }
    function setEnabled() {
        UE.getEditor('editor').setEnabled();
        enableBtn();
    }
    function getText() {
        //当你点击按钮时编辑区域已经失去了焦点，如果直接用getText将不会得到内容，所以要在选回来，然后取得内容
        var range = UE.getEditor('editor').selection.getRange();
        range.select();
        var txt = UE.getEditor('editor').selection.getText();
        alert(txt)
    }
    function getContentTxt() {
        var arr = [];
        arr.push("使用editor.getContentTxt()方法可以获得编辑器的纯文本内容");
        arr.push("编辑器的纯文本内容为：");
        arr.push(UE.getEditor('editor').getContentTxt());
        alert(arr.join("\n"));
    }
    function hasContent() {
        var arr = [];
        arr.push("使用editor.hasContents()方法判断编辑器里是否有内容");
        arr.push("判断结果为：");
        arr.push(UE.getEditor('editor').hasContents());
        alert(arr.join("\n"));
    }
    function setFocus() {
        UE.getEditor('editor').focus();
    }
    function deleteEditor() {
        disableBtn();
        UE.getEditor('editor').destroy();
    }
    function disableBtn(str) {
        var div = document.getElementById('btns');
        var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
        for (var i = 0, btn; btn = btns[i++];) {
            if (btn.id == str) {
                UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
            } else {
                btn.setAttribute("disabled", "true");
            }
        }
    }
    function enableBtn() {
        var div = document.getElementById('btns');
        var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
        for (var i = 0, btn; btn = btns[i++];) {
            UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
        }
    }
    function getLocalData () {
        alert(UE.getEditor('editor').execCommand( "getlocaldata" ));
    }
    function clearLocalData () {
        UE.getEditor('editor').execCommand( "clearlocaldata" );
        alert("已清空草稿箱")
    }
</script>
<script>
	
	console.log("进入首页，正在开始注册websocket......");
	var websocket = new WebSocket("ws://127.0.0.1:8080/mywebsocket");
	//开启websocket
	websocket.onopen = function(){
		console.log("连接成功.....");
	}
	websocket.onclose = function(){
		console.log("连接断开.....");
	}
	websocket.onerror = function(){
		console.log("连接异常.....");
	}
	websocket.onmessage = function(msg){
		console.log("接收到通信的消息."+msg.data+'\n'+v.user.userid);
// 		alert(msg.data.substring(0,msg.data.indexOf("-")).toString())
		var chatid=msg.data.substring(0,msg.data.indexOf("-"))
		if(v.currentchatid==chatid){
			//当前聊天对象的消息
			$(".m_body .view").append(msg.data.substring(msg.data.indexOf("-")+1));
			adduserimg()
		}else if(v.user.userid==chatid){
			//自己刚发的消息
			$(".m_body .view").append(msg.data.substring(msg.data.indexOf("-")+1));
			adduserimg()
			alert("刚发送的")
		}else if("notice"==chatid){
			//通知
			
			alert("通知")
		}else{
			//其他好友的消息
			tips("系统","你有一条系统消息","javascript:void(0)")
// 			alert("你有一条其他好友的消息")
		}
	}
	//var httpRequest = new XMLHttpRequest();
	$(function(){
		$("#msgBtn").click(function(){
			var id = $("#sendMsgBox input[type=hidden]").val();
			if(!id){
				alert("请选择一个用户");
				return;
			}
			var msg = $("[name=msgCtx]").val();
			if(!msg)
			{
				alert("消息内容不能为空");
				return;
			}
			
			$.ajax({
				url:"/sendMsg",
				data:{
					uid:id,
					msg:msg
				},
				type:"post",
				dataType:"text",
				success:function(stu){
					alert(stu);
				}
			});
		});
		$("tr:not(:first)").click(function(){
			var id = $(this).find("td:eq(0)").html();
			$("#sendMsgBox input[type=hidden]").val(id)
			var name = $(this).find("td:eq(1)").html();
			$("#msgName").html(name)
		});
		// UE.getEditor('editor').setHeight(300)
		$(".addchat option").click(function(){
			alert($(".addchat").val())
		})
		getLoginUserInMessage()
		getChatList()
// 		getChatRecord()
	})
	ue.ready(function(){
		UE.getEditor('editor').setHeight(73)
	})
	var v=new Vue({
		el : ".tzx",
		data : {
			user:{userid:"2"},
			currentchatid:null,
			chatlist:null,
			chatrecord:null,
			userimg:[{userid:"0",img:"/static/image/profile.jpg"},{userid:"1",img:"/static/image/profile2.jpg"},{userid:"3",img:"/static/image/studentimg.png"},{userid:"4",img:"/static/image/studentimg.png"}],
			nid:'abc',
			alluserlist:null,
		},
		methods:{
			jump:function(chatid,name){
				console.log("切换聊天对象："+chatid)
				v.currentchatid=chatid
// 				alert(chatid)
				$(".m_top h6").text(name)
				getChatRecord()
			},
			//关闭聊天列表移除指定用户
			closechat:function(userid){
// 				alert(userid)
				var index=0;
				for(i=0;i<v.chatlist.length;i++){
					if(userid==v.chatlist[i].userid){
						index=i
					}
				}
				console.log("正在移出聊天列表："+index)
				v.chatlist.splice(index,1)
				//获取聊天记录
				v.currentchatid=v.chatlist[0].userid
				$(".m_top h6").text(v.chatlist[0].name)
				getChatRecord()
			}
		}
	})
	//获取用户头像
	function getuserimg(userid){
		for(var i=0;i<v.userimg.length;i++){
			if(userid==v.userimg[i].userid){
				console.log(userid+"-"+v.userimg[i].userid+"-"+v.userimg[i].img)
				if(v.userimg[i].img==null){
					return "/static/image/profile.jpg";
				}else{
					return v.userimg[i].img
				}
			}
		}
		return "profile.jpg"
	}
	//在聊天消息前添加头像
	function adduserimg(){
		$(".userimg").remove()
		$(".m_message_left").prepend("<img src="+getuserimg(v.currentchatid)+" width='25px' height='25px'/ class='userimg'>");
		$(".m_message_right").append("<img src="+v.user.userimg+" width='25px' height='25px'/ class='userimg'>");
		msg_end.click()
	}
	//发送消息
	function senderMessage(){
		var receiver=v.currentchatid
		var content=UE.getEditor('editor').getContent()
		if(""==content||null==content){
			alert("内容为空！")
			return
		}
		UE.getEditor('editor').setContent('');
		alert(content)
		$.post("senderMessage","receiver[0]="+receiver+"&content="+content,function(result){
			console.log("发送结果："+result)
			if("000000"==result){
				alert("发送失败！请检查网络。")
			}
		})
		
	}
	//群发消息-弹窗-选择接收人
	function TosenderMultiMessage(){
		var content=UE.getEditor('editor').getContent()
		if(""==content||null==content){
			alert("内容为空！")
		}else{
			$(".cpm").show()
			$(".cpm ul li ul li button").hide()
			$(".cpm input[type=checkbox]").show()
			$(".cpm .btnchooseAll").show()
			
		}
	}
	//群发消息
	function senderMultiMessage(receiver){
// 		var receiver=[]
		if(receiver.length==0){
			alert("请选择接收人！")
			return
		}
		var receiverStr=''
		for(var i=0;i<receiver.length;i++){
			receiverStr+="&receiver["+i+"]="+receiver[i]
		}
		var content=UE.getEditor('editor').getContent()
		UE.getEditor('editor').setContent('');
		alert(content+"群发:\n"+receiverStr)
		$.post("senderMessage","content="+content+receiverStr,function(result){
			console.log("发送结果："+result)
			if("000000"==result){
				alert("发送失败！请检查网络。")
			}
		})
		
	}
	//获取聊天记录
	function getChatRecord(){
		if(v.currentchatid==null){
			v.currentchatid=0
		}
		console.log("获取聊天记录，当前聊天对象："+v.currentchatid)
		$.post("getChatRecord","chatid="+v.currentchatid,function(result){
			console.log(result)
			v.chatrecord=result
			$(".m_body .view").html("")
			if(result==null){
				alert("空空如也！")
			}
			for(var i=0;i<result.length;i++){
				if(v.user.userid==result[i].sender){
					$(".m_body .view").append("<div class=\"m_message_right\">"+result[i].content+"</div>");
				}else{
					$(".m_body .view").append("<div class=\"m_message_left\">"+result[i].content+"</div>");
				}
			}
			adduserimg()
		})
	}
	//获取聊天列表
	function getChatList(){
		$.post("getChatList","",function(result){
			console.log(result)
			v.chatlist=result
			v.currentchatid=result[0].userid
			$(".m_top h6").text(result[0].name)
			for(i=0;i<result.length;i++){
				var item={}
				item['userid']=result[i].userid
				item['img']=result[i].url
				v.userimg.push(item)
				console.log("正在刷新聊天列表："+result[i].url)
			}
			//获取聊天记录
			getChatRecord()
			
		})
	}
	//获取当前登录用户信息
	function getLoginUserInMessage(){
		$.post("getLoginUserInMessage","",function(result){
			console.log(result)
			v.user=result
		})
	}
	//获取弹窗中绑定的用户信息列表（userid/name/url）
	function getAllUserList(){
		$.post("getAllUserList","",function(result){
			console.log(result)
			v.alluserlist=result
		})
	}
	//消息弹出提示
	function tips(title,content,url){
		var placementFrom = "bottom";
		var placementAlign = "right";
		var state = "info";
		var style = "withicon";
		var content = {};
		content.message = '测试消息';
		content.title = '系统';
		if (style == "withicon") {
			content.icon = 'la la-bell';
		} else {
			content.icon = 'none';
		}
		content.url = url;
		content.target = '_self';
		$.notify(content,{
			type: state,
			placement: {
				from: placementFrom,
				align: placementAlign
			},
			time: 1000,
		});
	}
	//定位聊天信息滚动条到底部
	function onGetMessage(context) {
		msg.innerHTML+=context;
		msg_end.click(); 
	}
	//未读
	function unReadCount(nid,num){
		var li= $(".m_left ul li")
		for(i=0;i<li.length;i++){
			var n=$(li[i]).attr("nid")
			alert("id为："+n)
			var newcount=0
			if(nid==n){
				var count=$(li[i]).find(".m_unReadCount").text()
				if(num==0){
					newcount=0
				}else if(num>0){
					newcount+=count
				}
				$(li[i]).find(".m_unReadCount").text(newcount)
			}
		}
	}
	//弹窗-查找好友
	function ToFindFriend(){
		console.log("弹窗-查找好友-")
		$(".cpm").show()
		$(".cpm ul li ul li button").show()
		$(".cpm input[type=checkbox]").hide()
		$(".cpm .btnchooseAll").hide()
	}
	//弹窗-查找好友-点击选择
	function chooseOne(nid,name,img){
		console.log("选择了一个用户："+nid)
		alert("选择了一个用户："+nid+"你可以开始聊天了！")
		$(".cpm").hide()
		var newchat={"userid":nid,"name":name,"url":img}
		var newimg={"userid":nid,"img":img}
		v.chatlist.push(newchat)
		v.userimg.push(newimg)
		console.log(v.chatlist)
		console.log(v.userimg)
	}
	
	function chooseAll(nid){
		alert("chooseAll啊啊啊啊")
		var receiver=[]
		$(".cpm ul li input[type='checkbox']").each(function () {
		    if ($(this).is(":checked")) {
				receiver.push($(this).val())
		        console.log($(this).val())
		        alert("选中")
		    } else {
		        alert("未选中")
		    }
		});
		console.log(receiver)
		senderMultiMessage(receiver)
	}
	function chooseClose(){
		console.log("取消了选择")
		$(".cpm").hide()
	}
</script>
<script type="text/javascript">
    UE.Editor.prototype._bkGetActionUrl = UE.Editor.prototype.getActionUrl;
    UE.Editor.prototype.getActionUrl = function(action) {
        if (action == 'uploadimage' || action == 'uploadscrawl' || action == 'uploadimage') {
            return '/imgUpdate'; //在这里返回我们实际的上传图片地址
        } else {
            return this._bkGetActionUrl.call(this, action);
        }
    }
</script>
</html>
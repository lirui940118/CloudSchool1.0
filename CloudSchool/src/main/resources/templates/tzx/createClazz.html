<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>开班</title>
		<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
		<link rel="stylesheet" href="../static/css/bootstrap.min.css">
		<link rel="stylesheet" href="../static/css/ready.css">
		<script src="static/js/core/jquery.3.2.1.min.js"></script>
		<script src="../static/js/core/vue.js"></script>
		<style type="text/css">
			.jb .form-control{width: 50%;}
			.form-group, .form-check{padding: 10px 10px}
		</style>
	</head>

	<body>
		<div class="main-panel">
			<div class="content">
				<div class="container-fluid">
					<h4 class="page-title">开班</h4>
					<div class="tzx" style="width: 100%;height: 100%;">
						<div class="card jb">
							<div class="card-header">
								<div class="card-title">基本信息</div>
							</div>
							<div class="card-body">
								<div class="form-group">
									<label for="smallInput">名称：</label>
									<input type="text" class="form-control form-control-sm" id="smallInput" name="cname" placeholder="AT1717">
								</div>
								<div class="form-group">
									<label for="exampleSelect">版本：</label>
									<select class="form-control form-control-sm" id="smallSelect" name="vid" @change="getSelVersion(version)" v-model="version">
										<option v-for="obj,index in versionlist" v-bind:vid="obj.vid" v-bind:value="obj.vid">{{obj.versionof}}</option>
									</select>
								</div>
								<div class="form-group">
									<label for="exampleSelect">年级：</label>
									<select class="form-control form-control-sm" id="smallSelect" name="gid" @change="getSelGrade(grade)" v-model="grade">
										<option v-for="obj,index in gradelist" v-bind:gid="obj.gid" v-bind:value="obj.gid">{{obj.gradeName}}</option>
									</select>
								</div>
								<div class="form-group">
									<label for="exampleSelect">专业：</label>
									<select class="form-control form-control-sm" id="smallSelect" name="mid" @change="getSelMajor(major)" v-model="major">
										<option v-if="-1==major" mid="-1" value="-1">该年级不分专业</option>
										<option v-for="obj,index in selmajorlist" v-bind:mid="obj.mid" v-bind:value="obj.mid">{{obj.majorName}}</option>
<!-- 										<optgroup v-for="obj,index in versionlist" v-bind:vid="obj.vid" label="obj.versionof"> -->
<!-- 											<sonOfBC v-for="obj1,index in majorlist"> -->
<!-- 												<option v-if="obj1.user1==version" v-bind:mid="obj1.mid" v-bind:value="obj1.mid">{{obj1.majorName}}</option> -->
<!-- 											</sonOfBC> -->
<!-- 										</optgroup> -->
									</select>
								</div>
								<div class="form-group">
									<label for="exampleSelect">班主任：</label>
									<select v-if="null!=mlist" class="form-control form-control-sm" id="smallSelect" name="tid">
										<option v-for="obj,index in mlist.staffVOList" v-bind:value="obj.staffId">{{obj.staffName}}--综合评分：{{obj.staffScore}}</option>
									</select>
									<select v-if="null==mlist" class="form-control form-control-sm" id="smallSelect" name="tid">
										<option value="-1">为查询到班主任</option>
									</select>
								</div>
							</div>

						</div>

						<div class="card teacher">
							<div class="card-header">
								<div class="card-title">选择教员</div>
							</div>
							<div class="card-body">
								<table class="table table-hover">
									<thead>
										<tr>
											<th scope="col">名称</th>
											<th scope="col">专业</th>
											<th scope="col">课时</th>
											<th scope="col">版本</th>
											<th scope="col">没想好</th>
											<th scope="col">教员</th>
										</tr>
									</thead>
									<tbody>
										<tr v-for="obj,index in tlist" class="t-content">
											<td><input type="hidden" name=courseid v-bind:value="obj.courseId" style="border: 0px;width: 100%;">{{obj.courseName}}</td>
											<td>{{getVMname(1)}}</td>
											<td>{{obj.coursePeriod}}</td>
											<td>{{getVMname(0)}}</td>
											<td>30</td>
											<td>
												<select v-if="null!=tlist" class="form-control form-control-sm" id="smallSelect" name=tid>
													<option v-for="obj1,index1 in obj.staffVOList" v-bind:value="obj1.staffId">{{obj1.staffName}}</option>
												</select>
												<select v-if="null==tlist" class="form-control form-control-sm" id="smallSelect" name=tid>
													<option value="-1">为查询到教员</option>
												</select>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>
						
						<div class="card student">
							<div class="card-header">
								<div class="card-title">选择学生</div>
							</div>
							<div class="card-body">
								<table class="table table-hover">
									<thead>
										<tr>
											<th scope="col">学号</th>
											<th scope="col">姓名</th>
											<th scope="col">年级</th>
											<th scope="col">生日</th>
											<th scope="col">版本</th>
											<th scope="col">状态</th>
											<th scope="col">操作</th>
										</tr>
									</thead>
									<tbody>
										<tr class="s-content">
											<td><input type="hidden" name=sid value="1" style="border: 0px;width: 100%;">201801010001</td>
											<td>张三</td>
											<td>S1</td>
											<td>2000.11.11</td>
											<td>ACCP8.0</td>
											<td>新生</td>
											<td>删除</td>
										</tr>
										<tr class="s-content">
											<td><input type="hidden" name=sid value="2" style="border: 0px;width: 100%;">201801010001</td><td>张三</td><td>S1</td><td>2000.11.11</td>
											<td>ACCP8.0</td><td>新生</td><td>删除</td>
										</tr>
										<tr class="s-content">
											<td><input type="hidden" name=sid value="3" style="border: 0px;width: 100%;">201801010001</td><td>张三</td><td>S1</td><td>2000.11.11</td>
											<td>ACCP8.0</td><td>新生</td><td>删除</td>
										</tr>
										<tr class="s-content">
											<td><input type="hidden" name=sid value="4" style="border: 0px;width: 100%;">201801010001</td><td>张三</td><td>S1</td><td>2000.11.11</td>
											<td>ACCP8.0</td><td>新生</td><td>删除</td>
										</tr>
										
									</tbody>
								</table>
								<p class="demo">
									<button class="btn btn-primary btn-xs">添加学生</button>
								</p>
							</div>
						</div>
						<p class="demo">
							<button class="btn btn-success btn-lg" onclick="createClazz()">马上开班</button>
							<button class="btn btn-link" disabled style="color: red;">放弃</button>
						</p>
					</div>
				</div>
			</div>
		</div>
	</body>
	<script>
	var v=new Vue({
		el : ".tzx",
		data : {
			user:{userid:"2"},
			versionlist:null,	//版本列表
			gradelist:null,		//年级列表
			majorlist:null,		//所有专业列表
			selmajorlist:null,	//筛选出的专业列表结果
			version:null,
			grade:null,
			major:null,	//null为非正常获取  0位改年级不分专业  >0表示正常专业
			teacherlist:null,
			studentlist:null,
			pc:null,
			cname:null,
			mlist:null,
			tlist:null
		},
		methods:{
			//获取选择的版本或专业名称-来自当前的下选框
			getVMname:function(vm){
				var name=""
				if(0==vm){
					var name=$("select[name=vid]").find("option:selected").text()
				}else{
					var name=$("select[name=mid]").find("option:selected").text()
				}
				return name
			},
			getSelVersion:function(version){
				console.log("选择版本："+version)
				v.version=version
				v.tlist=null
				getAllGrade(version)
			},
			getSelGrade:function(grade){
				console.log("选择了年级："+grade)
				v.grade=grade
				v.tlist=null
				//绑定版本年级对应的专业列表
				BindingMajorListAfterselGrade()
			},
			getSelMajor:function(major){
				alert(major)
				console.log("选择专业："+major)
				v.major=major
			}
		}
	})
	$(function(){
		getAllVersion();
// 		getAllGrade(vid)
		getAllMajor()
		
		
			console.log(v.version)
	})
	//开班
	function createClazz(){
		if(null==v.major){
			alert("所选专业信息异常，无法开班")
			return
		}
		console.log("版本-年级-专业："+v.version+"-"+v.grade+"-"+v.major)
		var cname=$("[name=cname]").val()
		var gid=$("[name=gid]").val()
		var mid=$("[name=mid]").val()
		var tid=$("[name=tid]").val()
		var data="cname="+cname+"&gid="+gid+"&mid="+mid;
		var tlist=$(".teacher table .t-content")
		var slist=$(".student table .s-content")
		data+="&tlist[0].tid="+tid+"&tlist[0].ismaster=1&tlist[0].isteacher=0"
		$.each(tlist,function(index,obj){
			var courseid=$(obj).find("input[name=courseid]").val()
			var tid=$(obj).find("[name=tid]").val()
			data+="&tlist["+(index+1)+"].courseid="+courseid+"&tlist["+(index+1)+"].tid="+tid+"&tlist["+(index+1)+"].isMaster=0&tlist["+(index+1)+"].isTeacher=1"
			console.log(obj)
		})
		$.each(slist,function(index,obj){
			var sid=$(obj).find("[name=sid]").val()
			data+="&slist["+(index)+"].studentid="+sid
			console.log(obj)
		})
		alert("添加学生："+slist.length)
		data+="&count="+slist.length
		console.log(data)
// 		$.post("craeteClazz",data,function(result){
// 			alert(result)
// 			console.log(result)
// 		})
	}
	//获取版本
	function getAllVersion(){
		$.post("zzy/AjaxqueryAllVersion","",function(result){
			console.log("获取到版本：")
			console.log(result)
			v.versionlist=result
			v.version=v.versionlist[0].vid
			console.log(v.version)
			//默认加载第一个版本的年级
			getAllGrade(v.version)
		})
	}
	//获取年级--/queryByvid  --/queryGradeAll
	function getAllGrade(vid){
		$.post("zzy/queryByvid","vid="+vid,function(result){
			console.log("获取到年级：")
			console.log(result)
			v.gradelist=result
			if(result.length==0){
				v.grade=null
				v.major=null
				alert("没有找到相关年级")
			}else{
				v.grade=v.gradelist[0].gid
				//绑定版本年级对应的专业列表
				BindingMajorListAfterselGrade()
			}
			console.log(v.grade)
		})
	}
	//获取所有专业
	function getAllMajor(){
		$.post("zzy/queryMajorAll","",function(result){
			console.log("获取到专业：")
			console.log(result)
			v.majorlist=result
			if(result.length==0){
				v.major=null
				alert("获取数据异常：未正常查询到所有专业列表")
			}
		})
	}
	//选择年级后判断是否需要选择专业---并----绑定专业列表
	function BindingMajorListAfterselGrade(){
		var majorbool=null;
		for(var i=0;i<v.gradelist.length;i++){
			if(v.grade==v.gradelist[i].gid){
				var majorbool=v.gradelist[i].user1
			}
		}
		if(1==majorbool){
			console.log("该年级分了专业")
			if(v.majorlist==null){
				getAllMajor()
				if(v.majorlist==null){
					return
				}
			}
			var list=[]
			for(var i=0;i<v.majorlist.length;i++){
				if(v.majorlist[i].user1==v.version){
					list.push(v.majorlist[i])
				}
			}
			v.selmajorlist=list
			console.log("相关专业："+v.selmajorlist.length)
			if(0==v.selmajorlist.length){
				console.log("数据异常:专业列表中没有匹配的专业")
				v.major=null
			}else{
				v.major=v.selmajorlist[0].mid
				//获取课程-教员
				getTeacherList()
			}
			console.log(v.selmajorlist)
		}else{
			console.log("该年级不分专业")
			v.major=-1
			//获取课程-教员
			getTeacherList()
		}
	}
	//分配班级编号名
	function allotClazzName(){
		var id=0
		var array=[]
		arrayStr="&array=5&array=6&array=9&array=10&array=12&array=13&array=14";
		$.post("allotClazzName","id="+id+arrayStr,function(result){
			console.log("获取到专业：")
			console.log(result)
			v.majorlist=result
			if(result.length==0){
				v.major=null
				alert("获取数据异常：未正常查询到所有专业列表")
			}
		})
	}
	//分配班级批次
	function allotClazzName(){
		if(v.grade==null){
			alert("请先选择年级,才能分配到班级批次！")
			return
		}
		$.post("allotClazzPC","gid="+v.grade,function(result){
			console.log("获取到专业：")
			console.log(result)
			v.pc=result
		})
	}
	//获取课程-教员列表
	function getTeacherList(){
		if(v.grade==null||v.major==null){
			alert("所选年级或专业信息不全！")
			return
		}
		var gId=v.grade
		var mId=v.major
		console.log("查询课程-教员条件："+gId+"-"+mId)
		$.post("statistics/getStaffsAboutOpenClass","gId="+gId+"&mId="+mId,function(result){
			console.log("获取到课程-教员列表：")
			console.log(result)
			v.teacherlist=result
			if(result.length==0){
				v.teacherlist=null
				v.mlist=null
				v.tlist=null
				alert("获取数据异常：未正常查询到所有课程-教员列表")
			}else{
				v.mlist=v.teacherlist[0]
				v.tlist=v.teacherlist.splice(1,v.teacherlist.length-1)
			}
		})
	}
	</script>
</html>